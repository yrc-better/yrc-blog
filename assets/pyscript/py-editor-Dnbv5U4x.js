import{T as e,c as t,X as n,d as r,a as o,r as s,o as i,H as a,s as c,w as l}from"./core-BEsfJxiI.js";import{notify as d}from"./error-CYIJakmx.js";const u='<svg style="height:24px;width:24px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,12a1,1,0,0,1-.55.89l-10,5A1,1,0,0,1,8,18a1,1,0,0,1-.53-.15A1,1,0,0,1,7,17V7a1,1,0,0,1,1.45-.89l10,5A1,1,0,0,1,19,12Z" fill="#464646"/></svg>';let p=0;const f=e=>`${e}-editor-${p++}`,v=new Map,g=new Map,h=new WeakMap,m={worker:{codeBeforeRun:()=>c,onReady:({runAsync:e,io:t},{sync:n})=>{t.stdout=t.buffered(n.write),t.stderr=t.buffered(n.writeErr),n.revoke(),n.runAsync=e}}},y=(e,t)=>{if("boolean"==typeof t)throw`Invalid source: ${e}`;return t},b=(e,t)=>{const n=e.closest(`.${t}-editor-box`);return n?.parentNode?.previousElementSibling};async function w({currentTarget:t,script:o}){const{env:c,pySrc:p,outDiv:f}=this,g=!!t;if(g&&(t.classList.add("running"),t.innerHTML='<svg style="height:24px;width:24px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 7h10v10H7z" style="fill:#464646;stroke:#464646;stroke-width:1;stroke-linecap:butt;stroke-linejoin:round;stroke-dasharray:none;paint-order:normal"/></svg>',f.innerHTML=""),!v.has(c)){const u=URL.createObjectURL(new Blob([""])),p={type:this.interpreter,serviceWorker:this.serviceWorker},{config:f}=this;if(f)try{if(p.configURL=s(f),f.endsWith(".toml")){const[{parse:e},t]=await Promise.all([import("./toml-Blg7Izee.js"),fetch(f).then(e=>e.ok&&e.text())]);p.config=e(y(f,t))}else if(f.endsWith(".json")){const e=await fetch(f).then(e=>e.ok&&e.json());p.config=y(f,e)}else p.configURL=s("./config.txt"),p.config=JSON.parse(f);p.version=i(p.config)}catch(e){return void d(e)}else p.config={};const h=n.call(new a(null,m),u,p);if(g)for(const n of e.keys())if(o=b(t,n))break;r(o,{xworker:{value:h}});const{sync:w}=h,{promise:k,resolve:E}=l();v.set(c,k),w.revoke=()=>{URL.revokeObjectURL(u),E(h)}}return v.get(c).then(e=>{e.onerror=({error:e})=>{g&&f.insertAdjacentHTML("beforeend",`<span style='color:red'>${e.message||e}</span>\n`),console.error(e)};const n=()=>{if(g){t.classList.remove("running"),t.innerHTML=u;const{previousElementSibling:e}=t.closest("[data-env]").parentElement;e?.dispatchEvent(new Event("py-editor:done",{bubbles:!0,cancelable:!0}))}},{sync:r}=e;r.write=e=>{g?f.innerText+=`${e}\n`:console.log(e)},r.writeErr=e=>{g?f.insertAdjacentHTML("beforeend",`<span style='color:red'>${e}</span>\n`):(d(e),console.error(e))},r.runAsync(p).then(n,n)})}const k=(e,t)=>{e.xworker?.terminate();const n=e.cloneNode(!0);n.type=`${t}-editor`;const r=h.get(e);if(r){const t=r.state.doc.toString();n.textContent=t,h.delete(e),e.nextElementSibling.remove()}e.replaceWith(n)},E=(t,n)=>{const r=document.createElement("div");r.className=`${n}-editor-input`,r.setAttribute("aria-label","Python Script Area");const o=((t,n)=>{const r=document.createElement("button");return r.className=`absolute ${n}-editor-run-button`,r.innerHTML=u,r.setAttribute("aria-label","Python Script Run Button"),r.addEventListener("click",async o=>{if(r.classList.contains("running")&&confirm("Stop evaluating this code?")){const t=b(r,n);if(t){const r=t.getAttribute("env");if(r)for(const[t,o]of e)if(t===n){g.delete(`${o}-${r}`),v.delete(`${o}-${r}`);break}if(t.xworker)k(t,n);else{const e=`script[type^="${n}-editor"][env="${r}"]`;for(const t of document.querySelectorAll(e))k(t,n)}}return}r.blur(),await t.handleEvent(o)}),r})(t,n),s=document.createElement("div");return s.addEventListener("keydown",e=>{e.stopPropagation()}),r.append(o,s),r},$=(e,t)=>{const n=document.createElement("div");n.className=`${t}-editor-box`;const r=E(e,t),o=(e=>{const t=document.createElement("div");return t.className=`${e}-editor-output`,t.id=`${f(e)}-output`,t})(t);return n.append(r,o),[n,o,r.querySelector("button")]},x=async(e,s,i)=>{const[{basicSetup:a,EditorView:c},{Compartment:l},{python:u},{indentUnit:p},{keymap:v},{defaultKeymap:m,indentWithTab:b}]=await Promise.all([t.core,t.state,t.python,t.language,t.view,t.commands]);let k=e.hasAttribute("setup");const E=e.hasAttribute("config"),x=e.getAttribute("service-worker"),A=`${i}-${e.getAttribute("env")||f(s)}`;if(x&&(new n("data:application/javascript,postMessage(0)",{type:"dummy",serviceWorker:x}).onmessage=({target:e})=>e.terminate()),E&&g.has(A))throw new SyntaxError(g.get(A)?`duplicated config for env: ${A}`:`unable to add a config to the env: ${A}`);g.set(A,E);let S=e.textContent;const{src:L}=e;if(L)try{S=y(L,await fetch(L).then(e=>e.ok&&e.text()))}catch(e){return void d(e)}const M={handleEvent:w,serviceWorker:x,interpreter:i,env:A,config:E&&e.getAttribute("config"),get pySrc(){return k?S:q.state.doc.toString()},get outDiv(){return k?null:H}};let T;r(e,{target:{get:()=>T},handleEvent:{get:()=>M.handleEvent,set:e=>{M.handleEvent=e===w?w:async t=>{const{currentTarget:n}=t;r(t,{code:{value:M.pySrc}}),!1!==await e(t)&&await w.call(M,{currentTarget:n})}}},code:{get:()=>M.pySrc,set:e=>{k||q.update([q.state.update({changes:{from:0,to:q.state.doc.length,insert:e}})])}},process:{value(e,t=!1){if(t)return P();const n=k,r=S;k=!0,S=e;const o=()=>{k=n,S=r};return M.handleEvent({currentTarget:null}).then(o,o)}}});const j=()=>{const t=new Event(`${s}-editor`,{bubbles:!0});e.dispatchEvent(t)};if(k)return await M.handleEvent({currentTarget:null,script:e}),void j();const R=e.getAttribute("target");if(R){if(T=document.getElementById(R)||document.querySelector(R),!T)throw new Error(`Unknown target ${R}`)}else T=document.createElement(`${s}-editor`),T.style.display="block",e.after(T);T.id||(T.id=f(s)),T.hasAttribute("exec-id")||T.setAttribute("exec-id",0),T.hasAttribute("root")||T.setAttribute("root",T.id);const[C,H,W]=$(M,s);C.dataset.env=e.hasAttribute("env")?A:i;const U=C.querySelector(`.${s}-editor-input > div`).attachShadow({mode:"open"});U.innerHTML="<style> :host { all: initial; }</style>",T.appendChild(C);const N=o(e.textContent).trim(),B=/^([ \t]+)/m.test(N)?RegExp.$1:"    ",P=()=>W.click(),q=new c({extensions:[p.of(B),(new l).of(u()),v.of([...m,{key:"Ctrl-Enter",run:P,preventDefault:!0},{key:"Cmd-Enter",run:P,preventDefault:!0},{key:"Shift-Enter",run:P,preventDefault:!0},b]),a],foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],parent:U,doc:N});h.set(e,q),q.focus(),j()};let A=0,S=Promise.resolve();const L=()=>{A=0,M()},M=()=>{if(!A){A=setTimeout(L,250);for(const[t,n]of e){const e=`script[type="${t}-editor"]`;for(const r of document.querySelectorAll(e))r.type+="-active",S=S.then(()=>x(r,t,n))}return S}};new MutationObserver(M).observe(document,{childList:!0,subtree:!0});var T=M();export{T as default};
//# sourceMappingURL=py-editor-Dnbv5U4x.js.map
